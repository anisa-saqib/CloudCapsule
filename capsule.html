<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚òÅÔ∏è cloud capsule ¬∑ royal blue dreams</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Nunito:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    /* === LIGHT MODE - SOFT DREAMY PINK === */
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(145deg, #ffd9e8 0%, #ffe0f0 50%, #ffcce6 100%);
      height: 100vh;
      width: 100vw;
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === DARK MODE - ROYAL BLUE WITH GREEN HINT === */
    body.dark-mode {
      background: linear-gradient(145deg, #1E2E4F 0%, #253b5e 50%, #31487A 100%);
    }

    /* === CLOUDS BACKGROUND - NON-BLOCKING === */
    .clouds-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none !important;
      z-index: 1;
      overflow: hidden;
    }

    .cloud {
      position: absolute;
      border-radius: 1000px;
      backdrop-filter: blur(3px);
      opacity: 0.6;
      will-change: transform;
      pointer-events: none;
    }

    .cloud::before, .cloud::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
    }

    .cloud::before {
      width: 65%;
      height: 85%;
      top: -45%;
      left: 10%;
    }

    .cloud::after {
      width: 45%;
      height: 60%;
      top: -35%;
      right: 8%;
    }

    /* LIGHT MODE CLOUDS */
    body:not(.dark-mode) .cloud {
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 20px 40px rgba(255, 150, 200, 0.2);
    }

    body:not(.dark-mode) .cloud::before,
    body:not(.dark-mode) .cloud::after {
      background: rgba(255, 255, 255, 0.8);
    }

    /* DARK MODE CLOUDS */
    body.dark-mode .cloud {
      background: rgba(180, 200, 255, 0.1);
      box-shadow: 0 20px 40px rgba(0, 20, 40, 0.2);
    }

    body.dark-mode .cloud::before,
    body.dark-mode .cloud::after {
      background: rgba(180, 200, 255, 0.1);
    }

    /* CLOUD ANIMATIONS */
    @keyframes floatSlowly {
      0% { transform: translateX(-10vw) translateY(0); }
      50% { transform: translateX(40vw) translateY(-20px); }
      100% { transform: translateX(90vw) translateY(10px); }
    }

    @keyframes floatEvenSlower {
      0% { transform: translateX(-15vw) translateY(0); }
      50% { transform: translateX(50vw) translateY(15px); }
      100% { transform: translateX(110vw) translateY(-10px); }
    }

    /* 6 CLOUDS */
    .cloud1 { width: 320px; height: 115px; top: 15%; left: -5%; animation: floatSlowly 95s linear infinite; }
    .cloud2 { width: 280px; height: 100px; top: 40%; left: 20%; animation: floatEvenSlower 120s linear infinite; }
    .cloud3 { width: 360px; height: 130px; top: 70%; left: 45%; animation: floatSlowly 140s linear infinite; }
    .cloud4 { width: 240px; height: 85px; top: 25%; left: 70%; animation: floatEvenSlower 110s linear infinite; }
    .cloud5 { width: 300px; height: 110px; top: 55%; left: -10%; animation: floatSlowly 130s linear infinite; }
    .cloud6 { width: 260px; height: 95px; top: 85%; left: 30%; animation: floatEvenSlower 150s linear infinite; }

    /* === NOTIFICATION CONTAINER - CLICKABLE === */
    .notification-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .notification {
      background: rgba(255, 235, 245, 0.95);
      backdrop-filter: blur(10px);
      border: 3px solid white;
      border-radius: 30px;
      padding: 1rem 1.5rem;
      font-family: 'Baloo 2', cursive;
      color: #3a1a32;
      box-shadow: 0 5px 0 #b07a9a, 0 10px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 280px;
      max-width: 350px;
      transform: translateX(-120%);
      animation: slideIn 0.5s forwards;
      cursor: pointer;
      transition: all 0.2s ease;
      pointer-events: auto;
      position: relative;
      z-index: 10000;
    }

    .notification:hover {
      transform: scale(1.02) translateX(5px);
      box-shadow: 0 8px 0 #b07a9a, 0 15px 25px rgba(0, 0, 0, 0.15);
    }

    body.dark-mode .notification {
      background: #1E2E4F;
      color: #e8f0ff;
      border-color: #4a6080;
      box-shadow: 0 5px 0 #0f1a2a, 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .notification:hover {
      box-shadow: 0 8px 0 #0f1a2a, 0 15px 25px rgba(0, 0, 0, 0.4);
    }

    @keyframes slideIn {
      to { transform: translateX(0); }
    }

    .notification i {
      font-size: 2rem;
      color: #b07a9a;
    }

    body.dark-mode .notification i {
      color: #a0c0ff;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.2rem;
    }

    .notification-message {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* === MAIN CONTENT - CLICKABLE === */
    .homepage {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 1rem;
      pointer-events: none;
    }

    .homepage * {
      pointer-events: auto;
    }

    /* === TITLE === */
    .hero-title {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(3.2rem, 11vw, 6rem);
      font-weight: 800;
      color: #3a1a32;
      text-shadow: 
        5px 5px 0 #ff9fc7,
        9px 9px 0 rgba(160, 70, 120, 0.15);
      line-height: 1;
      margin-bottom: 0.3rem;
      letter-spacing: 3px;
      animation: bubble 4s ease-in-out infinite;
      transform-origin: center;
      display: block;
      white-space: normal;
      word-break: break-word;
      max-width: 90%;
    }

    body.dark-mode .hero-title {
      color: #e8f0ff;
      text-shadow: 
        4px 4px 0 #1E2E4F,
        8px 8px 0 rgba(20, 40, 60, 0.5),
        0 0 20px rgba(200, 220, 255, 0.2);
    }

    @keyframes bubble {
      0%, 100% { transform: scale(1) translateY(0); }
      50% { transform: scale(1.02) translateY(-5px); }
    }

    /* === PUNCHLINE === */
    .punchline {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(0.8rem, 2.5vw, 1.1rem);
      color: #552a45;
      text-shadow: 1px 1px 0 #ff9fc7;
      margin: 0.4rem 0 1.8rem;
      letter-spacing: 1px;
      background: rgba(255, 215, 235, 0.25);
      padding: 0.4rem 1.2rem;
      border-radius: 40px;
      backdrop-filter: blur(4px);
      border: 1.5px dashed #ffa5cc;
      display: inline-block;
    }

    body.dark-mode .punchline {
      color: #d0e0ff;
      text-shadow: 1px 1px 0 #1E2E4F;
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    /* === BUTTON CONTAINER === */
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      align-items: center;
      margin: 0.8rem 0;
      width: 100%;
      max-width: 280px;
    }

    /* GET STARTED BUTTON */
    .home-btn.get-started {
      background: rgba(255, 235, 245, 0.98);
      border: 4px solid white;
      border-radius: 60px;
      padding: 1.1rem 2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 800;
      font-size: clamp(1.2rem, 4vw, 1.6rem);
      color: #3a1a32;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 0 #b07a9a, 0 15px 30px rgba(140, 70, 100, 0.25);
      cursor: pointer;
      transition: all 0.08s linear;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: center;
      border-style: solid;
      border-color: #ffffff #d09ab8 #d09ab8 #ffffff;
    }

    .home-btn.get-started:hover {
      background: rgba(245, 225, 235, 0.98);
      border-color: #e0e0e0 #c090b0 #c090b0 #e0e0e0;
      transform: scale(1.02);
    }

    body.dark-mode .home-btn.get-started {
      background: linear-gradient(145deg, #31487A, #1E2E4F);
      color: #e8f0ff;
      border-color: #4a6080 #1a2a3a #1a2a3a #4a6080;
      box-shadow: 0 8px 0 #0f1a2a, 0 15px 30px rgba(0, 0, 0, 0.5);
    }

    /* LOGIN BUTTON */
    .home-btn.login {
      background: rgba(255, 235, 245, 0.85);
      border: 3px solid white;
      border-radius: 50px;
      padding: 0.6rem 1.4rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: clamp(0.8rem, 2.5vw, 1.1rem);
      color: #3a1a32;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 0 #b07a9a, 0 8px 15px rgba(140, 70, 100, 0.15);
      cursor: pointer;
      transition: all 0.08s linear;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      width: 70%;
      justify-content: center;
      border-style: solid;
      border-color: #ffffff #d09ab8 #d09ab8 #ffffff;
    }

    .home-btn.login:hover {
      background: rgba(245, 225, 235, 0.9);
      border-color: #e0e0e0 #c090b0 #c090b0 #e0e0e0;
      transform: scale(1.02);
    }

    body.dark-mode .home-btn.login {
      background: linear-gradient(145deg, #2a3a5a, #1E2E4F);
      color: #d0e0ff;
      border-color: #3a5070 #1a2a3a #1a2a3a #3a5070;
      box-shadow: 0 4px 0 #0f1a2a, 0 8px 15px rgba(0, 0, 0, 0.4);
    }

    /* === WELCOME MESSAGE === */
    .welcome-message {
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      color: #552a45;
      margin-top: 2.5rem;
      padding: 0.4rem 1.2rem;
      background: rgba(255, 215, 235, 0.2);
      border-radius: 40px;
      backdrop-filter: blur(4px);
      border: 1px dotted #ffa5cc;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    body.dark-mode .welcome-message {
      color: #b0c8ff;
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    /* === TOP BUTTONS - CLICKABLE === */
    .top-buttons {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
    }

    .about-btn, .dark-toggle {
      background: rgba(255, 235, 245, 0.9);
      border: 2px solid white;
      border-radius: 40px;
      padding: 0.5rem 1.2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: 0.9rem;
      color: #3a1a32;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 0 #b07a9a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.1s ease;
      pointer-events: auto;
      position: relative;
      z-index: 1001;
    }

    .about-btn:hover, .dark-toggle:hover {
      background: rgba(245, 225, 235, 0.95);
      border-color: #e0e0e0;
    }

    body.dark-mode .about-btn,
    body.dark-mode .dark-toggle {
      background: #1E2E4F;
      color: #d0e0ff;
      border-color: #4a6080;
      box-shadow: 0 4px 0 #0f1a2a;
    }

    /* === SIGN OUT BUTTON - CLICKABLE === */
    .sign-out-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #b07a9a;
      border: 3px solid white;
      border-radius: 40px;
      padding: 0.6rem 1.2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      box-shadow: 0 4px 0 #7a4a6a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
      pointer-events: auto;
      position: fixed;
      z-index: 1001;
    }

    body.dark-mode .sign-out-btn {
      background: #31487A;
      border-color: #a0c0ff;
      color: #ffffff;
      box-shadow: 0 4px 0 #1a2a3a;
    }

    .sign-out-btn:hover {
      transform: scale(1.02);
    }

    .sign-out-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #7a4a6a;
    }

    /* === MODAL OVERLAY - CLICKABLE === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
      padding: 1rem;
      pointer-events: none;
    }

    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
    }

    .modal-card {
      background: rgba(255, 245, 250, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 50px;
      border: 4px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 20px 40px rgba(140, 70, 100, 0.25), 0 8px 0 #b07a9a;
      padding: 2rem 1.8rem;
      width: 90%;
      max-width: 380px;
      position: relative;
      transform: scale(0.98);
      transition: transform 0.2s ease;
      pointer-events: auto;
    }

    .modal-overlay.show .modal-card {
      transform: scale(1);
    }

    body.dark-mode .modal-card {
      background: #1E2E4F;
      border-color: #4a6080;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 8px 0 #0f1a2a;
    }

    .modal-card h2 {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(1.6rem, 5vw, 2rem);
      color: #3a1a32;
      margin-bottom: 1rem;
    }

    body.dark-mode .modal-card h2,
    body.dark-mode .modal-card p,
    body.dark-mode .switch-text {
      color: #d0e0ff;
    }

    .password-container {
      position: relative;
      width: 100%;
      margin: 0.6rem 0;
    }

    .password-container input {
      width: 100%;
      padding: 0.9rem 3rem 0.9rem 1.4rem !important;
      margin: 0 !important;
    }

    .peek-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #b07a9a;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .peek-icon:hover {
      color: #8a5a7a;
      transform: translateY(-50%) scale(1.1);
    }

    body.dark-mode .peek-icon {
      color: #a0c0ff;
    }

    .modal-card input {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #ffb5d0;
      border-radius: 40px;
      padding: 0.9rem 1.4rem;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      width: 100%;
      margin: 0.6rem 0;
    }

    body.dark-mode .modal-card input {
      background: #253b5e;
      border-color: #4a6080;
      color: #e8f0ff;
    }

    .modal-btn {
      background: rgba(247, 200, 220, 0.98);
      border: 4px solid white;
      border-radius: 50px;
      padding: 1rem 2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.3rem;
      color: #3a1a32;
      box-shadow: 0 6px 0 #b07a9a;
      cursor: pointer;
      width: 100%;
      margin: 1.2rem 0;
      transition: all 0.08s ease;
    }

    .modal-btn:hover {
      background: rgba(237, 190, 210, 0.98);
      border-color: #e0e0e0;
    }

    body.dark-mode .modal-btn {
      background: #31487A;
      color: #e8f0ff;
      border-color: #5a7090;
      box-shadow: 0 6px 0 #0f1a2a;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #b07a9a;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-modal:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: rotate(90deg);
    }

    body.dark-mode .close-modal {
      color: #a0c0ff;
    }

    .switch-text {
      color: #5a3a4a;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
      transition: all 0.2s ease;
    }

    .switch-text:hover {
      color: #c07aa0;
      transform: translateX(5px);
    }

    body.dark-mode .switch-text:hover {
      color: #a0c0ff;
    }

    /* === ABOUT MODAL SCROLLABLE === */
    .about-story {
      max-height: 50vh;
      overflow-y: auto;
      padding: 0.5rem 1rem 0.5rem 0;
      margin: 1rem 0;
      scrollbar-width: thin;
      scrollbar-color: #c07aa0 #ffe5f0;
      font-size: 1rem;
      line-height: 1.6;
    }

    body.dark-mode .about-story {
      scrollbar-color: #4a6080 #1E2E4F;
    }

    .about-story::-webkit-scrollbar {
      width: 6px;
    }

    .about-story::-webkit-scrollbar-track {
      background: #ffe5f0;
      border-radius: 10px;
    }

    .about-story::-webkit-scrollbar-thumb {
      background: #c07aa0;
      border-radius: 10px;
    }

    body.dark-mode .about-story::-webkit-scrollbar-track {
      background: #1E2E4F;
    }

    body.dark-mode .about-story::-webkit-scrollbar-thumb {
      background: #4a6080;
    }

    .story-chapter {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 20px;
      background: rgba(255, 215, 235, 0.2);
      transition: transform 0.2s ease;
    }

    .story-chapter:hover {
      transform: scale(1.02);
      background: rgba(255, 215, 235, 0.3);
    }

    body.dark-mode .story-chapter {
      background: rgba(49, 72, 122, 0.2);
    }

    .chapter-title {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      color: #b86a98;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    body.dark-mode .chapter-title {
      color: #a0c0ff;
    }

    .story-text {
      color: #3a1a32;
      font-size: 0.95rem;
    }

    body.dark-mode .story-text {
      color: #d0e0ff;
    }

    .fun-fact {
      background: rgba(255, 180, 210, 0.2);
      border-left: 4px solid #c07aa0;
      padding: 0.8rem;
      margin: 1rem 0;
      border-radius: 15px;
      font-style: italic;
      font-size: 0.9rem;
    }

    /* === MAIN APP DASHBOARD === */
    #mainApp {
      position: relative;
      z-index: 20;
      height: 100vh;
      width: 100vw;
      overflow-y: auto;
      padding: 5rem 1rem 2rem;
      scrollbar-width: thin;
      scrollbar-color: #c07aa0 #ffe5f0;
      pointer-events: auto;
    }

    body.dark-mode #mainApp {
      scrollbar-color: #4a6080 #1E2E4F;
    }

    .dashboard-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .glass-card {
      background: rgba(255, 245, 250, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 50px;
      border: 4px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 0 #b07a9a;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    body.dark-mode .glass-card {
      background: #1E2E4F;
      border-color: #4a6080;
      color: #e8f0ff;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 8px 0 #0f1a2a;
    }

    .welcome-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .welcome-header h1 {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(1.8rem, 4vw, 2.2rem);
    }

    .create-capsule-btn {
      background: #b07a9a;
      border: 3px solid white;
      border-radius: 40px;
      padding: 0.8rem 1.5rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
      box-shadow: 0 5px 0 #7a4a6a;
    }

    body.dark-mode .create-capsule-btn {
      background: #31487A;
      box-shadow: 0 5px 0 #1E2E4F;
    }

    .create-capsule-btn:active {
      transform: translateY(5px);
      box-shadow: 0 2px 0 #7a4a6a;
    }

    /* === CAPSULE GRID === */
    .capsule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .capsule-card {
      background: rgba(255, 235, 245, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 1.5rem;
      border: 3px solid white;
      box-shadow: 0 8px 0 #b07a9a;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      pointer-events: auto;
    }

    body.dark-mode .capsule-card {
      background: rgba(30, 46, 79, 0.7);
      border-color: #4a6080;
      box-shadow: 0 8px 0 #0f1a2a;
    }

    /* SEALED BOX PATTERN */
    .capsule-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(45deg, 
          rgba(176, 122, 154, 0.15) 0px, 
          rgba(176, 122, 154, 0.15) 8px,
          transparent 8px, 
          transparent 16px),
        repeating-linear-gradient(-45deg, 
          rgba(176, 122, 154, 0.15) 0px, 
          rgba(176, 122, 154, 0.15) 8px,
          transparent 8px, 
          transparent 16px);
      pointer-events: none;
      z-index: 1;
    }

    body.dark-mode .capsule-card::before {
      background-image: 
        repeating-linear-gradient(45deg, 
          rgba(160, 192, 255, 0.15) 0px, 
          rgba(160, 192, 255, 0.15) 8px,
          transparent 8px, 
          transparent 16px),
        repeating-linear-gradient(-45deg, 
          rgba(160, 192, 255, 0.15) 0px, 
          rgba(160, 192, 255, 0.15) 8px,
          transparent 8px, 
          transparent 16px);
    }

    .capsule-card::after {
      content: '';
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      border: 2px dashed rgba(176, 122, 154, 0.3);
      border-radius: 20px;
      pointer-events: none;
      z-index: 1;
    }

    body.dark-mode .capsule-card::after {
      border-color: rgba(160, 192, 255, 0.3);
    }

    .capsule-card.unlocked::before,
    .capsule-card.unlocked::after {
      opacity: 0.1;
      transition: opacity 0.5s ease;
    }

    .capsule-card.locked {
      cursor: not-allowed;
      opacity: 0.9;
    }

    .capsule-card.locked:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 0 #b07a9a;
    }

    .capsule-card.unlocked:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 0 #b07a9a;
    }

    .capsule-icon {
      font-size: 2.5rem;
      color: #b07a9a;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 2;
    }

    body.dark-mode .capsule-icon {
      color: #a0c0ff;
    }

    .capsule-title {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      position: relative;
      z-index: 2;
    }

    .capsule-date {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
    }

    .capsule-badge {
      display: inline-block;
      padding: 0.2rem 1rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: bold;
      background: #b07a9a;
      color: white;
      position: relative;
      z-index: 2;
    }

    body.dark-mode .capsule-badge {
      background: #31487A;
    }

    /* === EMPTY STATE === */
    .empty-capsules {
      text-align: center;
      padding: 4rem 2rem;
      background: rgba(255, 235, 245, 0.3);
      border-radius: 40px;
      margin: 2rem 0;
      border: 2px dashed #ffb5d0;
      grid-column: 1 / -1;
    }

    body.dark-mode .empty-capsules {
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    .empty-capsules i {
      font-size: 4rem;
      color: #b07a9a;
      margin-bottom: 1rem;
      opacity: 0.7;
    }

    body.dark-mode .empty-capsules i {
      color: #a0c0ff;
    }

    .empty-capsules p {
      font-size: 1.5rem;
      font-family: 'Baloo 2', cursive;
      color: #b07a9a;
      margin-bottom: 0.5rem;
    }

    .empty-capsules .sub-note {
      font-size: 1rem;
      opacity: 0.8;
      color: #7a5a6a;
    }

    /* === CAPSULE DETAIL VIEW === */
    .capsule-detail {
      background: rgba(255, 235, 245, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 2rem;
      margin-top: 1rem;
    }

    body.dark-mode .capsule-detail {
      background: rgba(30, 46, 79, 0.7);
    }

    .secret-content {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    body.dark-mode .secret-content {
      background: rgba(20, 30, 50, 0.5);
    }

    /* === CREATE CAPSULE FORM === */
    .capsule-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .form-section {
      background: rgba(255, 235, 245, 0.5);
      border-radius: 30px;
      padding: 1.5rem;
    }

    body.dark-mode .form-section {
      background: rgba(30, 46, 79, 0.5);
    }

    .form-section h3 {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section input,
    .form-section textarea,
    .form-section select {
      width: 100%;
      padding: 0.8rem 1rem;
      margin: 0.5rem 0;
      border: 3px solid #ffb5d0;
      border-radius: 30px;
      font-family: 'Nunito', sans-serif;
      background: rgba(255, 255, 255, 0.9);
    }

    body.dark-mode .form-section input,
    body.dark-mode .form-section textarea,
    body.dark-mode .form-section select {
      background: #253b5e;
      border-color: #4a6080;
      color: #e8f0ff;
    }

    .form-section textarea {
      min-height: 100px;
      resize: vertical;
    }

    .file-upload {
      border: 3px dashed #ffb5d0;
      border-radius: 30px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
    }

    body.dark-mode .file-upload {
      border-color: #4a6080;
    }

    /* === WORKING RATING STARS === */
    .rating-stars {
      display: flex;
      gap: 5px;
      margin: 0.5rem 0;
      font-size: 1.5rem;
    }

    .rating-stars i {
      color: #ffb5d0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .rating-stars i:hover,
    .rating-stars i.active {
      color: #ff9fc7;
      transform: scale(1.1);
    }

    body.dark-mode .rating-stars i {
      color: #4a6080;
    }

    body.dark-mode .rating-stars i:hover,
    body.dark-mode .rating-stars i.active {
      color: #a0c0ff;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
    }

    .save-btn, .lock-btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 40px;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
    }

    .save-btn {
      background: #b07a9a;
      color: white;
      box-shadow: 0 6px 0 #7a4a6a;
    }

    .lock-btn {
      background: #4a6080;
      color: white;
      box-shadow: 0 6px 0 #1E2E4F;
    }

    .save-btn:active, .lock-btn:active {
      transform: translateY(6px);
      box-shadow: none;
    }

    .hidden {
      display: none !important;
    }

    .fas, .far, .fab {
      font-family: "Font Awesome 6 Free" !important;
    }

    @media (max-width: 600px) {
      .hero-title { font-size: clamp(2.8rem, 9vw, 4.5rem); }
      .punchline { font-size: 0.8rem; }
      .button-container { max-width: 240px; }
      .home-btn.login { width: 75%; }
      .top-buttons { top: 10px; left: 10px; gap: 5px; }
      .about-btn, .dark-toggle { padding: 0.4rem 1rem; font-size: 0.8rem; }
      .capsule-grid { grid-template-columns: 1fr; }
      .capsule-form { grid-template-columns: 1fr; }
      .form-actions { flex-direction: column; }
      .sign-out-btn { top: 10px; right: 10px; padding: 0.4rem 1rem; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

<!-- NOTIFICATION CONTAINER - BOTTOM LEFT -->
<div id="notificationContainer" class="notification-container"></div>

<!-- TOP BUTTONS CONTAINER -->
<div class="top-buttons">
  <button class="about-btn" onclick="showAboutModal()">
    <i class="fas fa-cloud"></i> ABOUT
  </button>
  <button class="dark-toggle" id="darkToggleBtn" onclick="toggleDarkMode()">
    <i class="fas fa-moon"></i> <span id="darkToggleText">DARK</span>
  </button>
</div>

<!-- FLOATING CLOUDS -->
<div class="clouds-background">
  <div class="cloud cloud1"></div>
  <div class="cloud cloud2"></div>
  <div class="cloud cloud3"></div>
  <div class="cloud cloud4"></div>
  <div class="cloud cloud5"></div>
  <div class="cloud cloud6"></div>
</div>

<!-- HOMEPAGE -->
<div id="homepage" class="homepage">
  <h1 class="hero-title">CLOUD<br>CAPSULE</h1>
  <div class="punchline">‚ú¶ seal your memories in the clouds ‚ú¶</div>
  <div class="button-container">
    <button class="home-btn get-started" onclick="openModal('register')">
      <i class="fas fa-feather"></i> GET STARTED
    </button>
    <button class="home-btn login" onclick="openModal('login')">
      <i class="fas fa-key"></i> LOGIN
    </button>
  </div>
  <div class="welcome-message">
    <i class="fas fa-cloud"></i> welcome home, dreamer <i class="fas fa-cloud"></i>
  </div>
</div>

<!-- LOGIN/REGISTER MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-card">
    <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
    
    <div id="loginForm">
      <h2>‚úß welcome back ‚úß</h2>
      <input type="email" id="loginEmail" placeholder="email">
      <div class="password-container">
        <input type="password" id="loginPassword" placeholder="password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('loginPassword', this)"></i>
      </div>
      <button class="modal-btn" onclick="handleLogin()">LOG IN</button>
      <div class="switch-text" onclick="switchToRegister()">new here? get started ‚Üí</div>
    </div>

    <div id="registerForm" class="hidden">
      <h2>‚úß hey there! ‚úß</h2>
      <p style="font-size: 1rem; margin-bottom: 0.8rem;">ready to make some memories?</p>
      <input type="text" id="regUsername" placeholder="username">
      <input type="email" id="regEmail" placeholder="email">
      <div class="password-container">
        <input type="password" id="regPassword" placeholder="password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('regPassword', this)"></i>
      </div>
      <div class="password-container">
        <input type="password" id="regConfirm" placeholder="confirm password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('regConfirm', this)"></i>
      </div>
      <button class="modal-btn" onclick="handleRegister()">GET STARTED</button>
      <div class="switch-text" onclick="switchToLogin()">already have an account? log in ‚Üí</div>
    </div>
  </div>
</div>

<!-- ABOUT MODAL -->
<div id="aboutModal" class="modal-overlay">
  <div class="modal-card" style="max-width: 550px;">
    <button class="close-modal" onclick="closeAboutModal()"><i class="fas fa-times"></i></button>
    <h2 style="text-align: center;">‚úß our story ‚úß</h2>
    <div class="about-story">
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-seedling"></i> chapter 1: a tiny idea</div><div class="story-text">once upon a time, on a rainy tuesday afternoon, two friends sat in a cozy caf√©. one was writing in a journal, the other was doodling clouds. "wouldn't it be nice," said the doodler, "if we could store memories in the clouds? like, actual clouds?" and the other laughed. but the idea stuck ‚òÅÔ∏è</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-cloud-moon"></i> chapter 2: why capsules?</div><div class="story-text">we thought about time capsules ‚Äî those little boxes you bury in the backyard and forget about. but who has a backyard anymore? and who wants to dig in the mud? so we thought: what if the capsule floated? what if it lived in the clouds, safe and pretty, until you're ready to open it? ‚ú®</div><div class="fun-fact">üåà fun fact: the first prototype was called "memory marshmallow" but it sounded too edible!</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-heart"></i> chapter 3: for the dreamers</div><div class="story-text">cloud capsule is for anyone who's ever wanted to: write a letter to their future self, save a secret too precious to share, capture a feeling before it fades, or simply leave a little time capsule for someone they love. it's for the hopeless romantics, the overthinkers, the memory-hoarders, and the cloud-gazers ‚òÅÔ∏èüíï</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-clock"></i> chapter 4: how it works</div><div class="story-text">you create a capsule. you fill it with photos, letters, secrets, songs, feelings. you pick a date in the future ‚Äî maybe your birthday, maybe a random tuesday. then you lock it, and it floats away into the cloud dimension. on that special day, it floats back down, and you get to meet your past self again. ü™Ñ</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-star"></i> chapter 5: the dream continues</div><div class="story-text">today, cloud capsule is a little corner of the internet where thousands of people store their memories. we've seen marriage proposals, graduation messages, goodbye letters to loved ones, and so many happy tears. and we're just getting started. the clouds are infinite, and so are the memories ‚ú®</div></div>
      <div style="text-align: center; margin: 2rem 0 1rem; padding: 1rem; background: rgba(199, 161, 219, 0.2); border-radius: 50px;"><p style="font-size: 1.2rem; font-family: 'Baloo 2';">thank you for being part of our story</p><p style="font-size: 0.9rem;">now go make some memories ü´ß</p></div>
    </div>
  </div>
</div>

<!-- MAIN APP - AFTER LOGIN -->
<div id="mainApp" class="hidden">
  <button class="sign-out-btn" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> SIGN OUT</button>
  <div class="dashboard-container">
    <div class="glass-card">
      <div class="welcome-header">
        <div><h1>ü´ß welcome back, <span id="usernameDisplay">dreamer</span></h1><p>your memories are safe in the clouds</p></div>
        <button class="create-capsule-btn" onclick="showCreateCapsule()"><i class="fas fa-plus-circle"></i> NEW CAPSULE</button>
      </div>
    </div>

    <div id="capsuleGridView">
      <div class="glass-card">
        <h2 style="font-family: 'Baloo 2'; margin-bottom: 1.5rem;"><i class="fas fa-box-archive"></i> your capsules</h2>
        <div id="capsuleGrid" class="capsule-grid"></div>
      </div>
    </div>

    <div id="capsuleDetailView" class="hidden">
      <div class="glass-card">
        <button class="create-capsule-btn" style="margin-bottom: 1rem;" onclick="backToGrid()"><i class="fas fa-arrow-left"></i> BACK TO CAPSULES</button>
        <div id="capsuleDetailContent"></div>
      </div>
    </div>

    <div id="createCapsuleView" class="hidden">
      <div class="glass-card">
        <h2 style="font-family: 'Baloo 2'; margin-bottom: 1.5rem;"><i class="fas fa-feather"></i> create new capsule</h2>
        <div class="capsule-form">
          <div class="form-section">
            <h3><i class="fas fa-info-circle"></i> basics</h3>
            <input type="text" id="capsuleName" placeholder="capsule name">
            <input type="datetime-local" id="capsuleOpenDate">
            <h3 style="margin-top: 1.5rem;"><i class="fas fa-camera"></i> photo</h3>
            <div class="file-upload" onclick="document.getElementById('photoUpload').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
              <p>click to upload a memory</p>
              <input type="file" id="photoUpload" style="display: none;" accept="image/*">
            </div>
          </div>
          <div class="form-section">
            <h3><i class="fas fa-envelope"></i> letter</h3>
            <textarea id="capsuleLetter" placeholder="dear future me..."></textarea>
            <h3 style="margin-top: 1rem;"><i class="fas fa-mask"></i> secret</h3>
            <textarea id="capsuleSecret" placeholder="something only you know..."></textarea>
          </div>
          <div class="form-section" style="grid-column: 1 / -1;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div><h3><i class="fas fa-heart"></i> feeling</h3><select id="capsuleFeeling"><option value="happy">happy</option><option value="nostalgic">nostalgic</option><option value="hopeful">hopeful</option><option value="thoughtful">thoughtful</option><option value="excited">excited</option></select></div>
              <div><h3><i class="fas fa-star"></i> rating</h3><div class="rating-stars" id="ratingStars"><i class="fas fa-star" onclick="setRating(1)"></i><i class="fas fa-star" onclick="setRating(2)"></i><i class="fas fa-star" onclick="setRating(3)"></i><i class="fas fa-star" onclick="setRating(4)"></i><i class="fas fa-star" onclick="setRating(5)"></i></div></div>
              <div><h3><i class="fas fa-music"></i> song</h3><input type="text" id="capsuleSong" placeholder="artist - track"></div>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button class="save-btn" onclick="saveCapsule()"><i class="fas fa-save"></i> SAVE CAPSULE</button>
          <button class="lock-btn" onclick="lockCapsule()"><i class="fas fa-lock"></i> LOCK & SEAL</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== CONFIGURATION ==========
  const API_URL = 'http://localhost:3000';
  
  // ========== STATE MANAGEMENT ==========
  let currentUser = null;
  let authToken = localStorage.getItem('token');
  let currentRating = 0;
  let capsules = [];
  let checkInterval = null;
  let notificationCheckInterval = null;

  // ========== DARK MODE TOGGLE ==========
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const toggleBtn = document.querySelector('.dark-toggle i');
    const toggleText = document.getElementById('darkToggleText');
    
    if (document.body.classList.contains('dark-mode')) {
      toggleBtn.className = 'fas fa-sun';
      toggleText.textContent = 'LIGHT';
      localStorage.setItem('darkMode', 'true');
    } else {
      toggleBtn.className = 'fas fa-moon';
      toggleText.textContent = 'DARK';
      localStorage.setItem('darkMode', 'false');
    }
  }

  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    const toggleBtn = document.querySelector('.dark-toggle i');
    const toggleText = document.getElementById('darkToggleText');
    if (toggleBtn) toggleBtn.className = 'fas fa-sun';
    if (toggleText) toggleText.textContent = 'LIGHT';
  }

  // ========== API HELPER ==========
  async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('token');
    options.headers = {
      ...options.headers,
      'Authorization': token ? `Bearer ${token}` : '',
      'Content-Type': 'application/json'
    };
    
    try {
      const response = await fetch(API_URL + url, options);
      return response;
    } catch (error) {
      console.error('Fetch error:', error);
      throw error;
    }
  }

  // ========== NOTIFICATION SYSTEM - CLICKABLE ==========
  function showNotification(title, message, capsuleId, icon = 'üéÅ') {
    const container = document.getElementById('notificationContainer');
    if (!container) return;
    
    // Remove old notifications if too many
    if (container.children.length > 3) {
      container.removeChild(container.firstChild);
    }
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.setAttribute('data-capsule-id', capsuleId);
    notification.setAttribute('onclick', `handleNotificationClick(this, ${capsuleId})`);
    
    let iconClass = 'fa-gift';
    if (icon === 'üîí') iconClass = 'fa-lock';
    else if (icon === '‚è∞') iconClass = 'fa-clock';
    
    notification.innerHTML = `
      <i class="fas ${iconClass}"></i>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
    `;
    
    // Make it clickable
    notification.addEventListener('click', function() {
      if (capsuleId) {
        viewCapsule(capsuleId);
        this.remove();
      }
    });
    
    container.appendChild(notification);
    
    // Auto remove after 8 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 8000);
  }

  // Fallback for onclick attribute
  window.handleNotificationClick = function(element, capsuleId) {
    viewCapsule(capsuleId);
    element.remove();
  };

  // ========== PASSWORD PEEK TOGGLE ==========
  function togglePasswordVisibility(inputId, icon) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  // ========== MODAL CONTROL ==========
  const modal = document.getElementById('modalOverlay');
  const aboutModal = document.getElementById('aboutModal');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const homepage = document.getElementById('homepage');
  const mainApp = document.getElementById('mainApp');

  function openModal(type) {
    if (!modal) return;
    modal.classList.add('show');
    if (type === 'login') {
      if (loginForm) loginForm.classList.remove('hidden');
      if (registerForm) registerForm.classList.add('hidden');
    } else {
      if (loginForm) loginForm.classList.add('hidden');
      if (registerForm) registerForm.classList.remove('hidden');
    }
  }

  function closeModal() { 
    if (modal) modal.classList.remove('show'); 
  }
  
  function showAboutModal() { 
    if (aboutModal) aboutModal.classList.add('show'); 
  }
  
  function closeAboutModal() { 
    if (aboutModal) aboutModal.classList.remove('show'); 
  }
  
  function switchToRegister() { 
    if (loginForm) loginForm.classList.add('hidden'); 
    if (registerForm) registerForm.classList.remove('hidden'); 
  }
  
  function switchToLogin() { 
    if (registerForm) registerForm.classList.add('hidden'); 
    if (loginForm) loginForm.classList.remove('hidden'); 
  }

  // ========== AUTH FUNCTIONS ==========
  async function handleLogin() {
    const email = document.getElementById('loginEmail')?.value;
    const password = document.getElementById('loginPassword')?.value;
    
    if (!email || !password) {
      alert('please enter email and password ‚úß');
      return;
    }
    
    try {
      const response = await fetch(API_URL + '/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Login failed');
      }
      
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      authToken = data.token;
      currentUser = data.user;
      
      const usernameDisplay = document.getElementById('usernameDisplay');
      if (usernameDisplay) {
        usernameDisplay.textContent = data.user.username || data.user.email.split('@')[0];
      }
      
      closeModal();
      if (homepage) homepage.classList.add('hidden');
      if (mainApp) mainApp.classList.remove('hidden');
      
      await loadCapsules();
      startPeriodicChecks();
      
    } catch (error) {
      alert('üîê ' + error.message);
    }
  }

  async function handleRegister() {
    const username = document.getElementById('regUsername')?.value;
    const email = document.getElementById('regEmail')?.value;
    const password = document.getElementById('regPassword')?.value;
    const confirm = document.getElementById('regConfirm')?.value;
    
    if (!username || !email || !password || !confirm) {
      alert('please fill all fields ‚úß');
      return;
    }
    
    if (password !== confirm) {
      alert('passwords don\'t match ‚úß');
      return;
    }
    
    try {
      const response = await fetch(API_URL + '/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Registration failed');
      }
      
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      authToken = data.token;
      currentUser = data.user;
      
      const usernameDisplay = document.getElementById('usernameDisplay');
      if (usernameDisplay) {
        usernameDisplay.textContent = data.user.username;
      }
      
      closeModal();
      if (homepage) homepage.classList.add('hidden');
      if (mainApp) mainApp.classList.remove('hidden');
      
      capsules = [];
      renderCapsuleGrid();
      startPeriodicChecks();
      
      alert('‚ú® welcome to cloud capsule!');
      
    } catch (error) {
      alert('üìÆ ' + error.message);
    }
  }

  function signOut() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    authToken = null;
    currentUser = null;
    capsules = [];
    
    if (mainApp) mainApp.classList.add('hidden');
    if (homepage) homepage.classList.remove('hidden');
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    if (notificationCheckInterval) {
      clearInterval(notificationCheckInterval);
      notificationCheckInterval = null;
    }
  }

  // ========== CAPSULE FUNCTIONS ==========
  async function loadCapsules() {
    try {
      const response = await fetchWithAuth('/api/capsules');
      
      if (!response.ok) {
        throw new Error('Failed to load capsules');
      }
      
      capsules = await response.json();
      renderCapsuleGrid();
      
    } catch (error) {
      console.error('Error loading capsules:', error);
      showNotification('Error', 'Could not load capsules', null, '‚ö†Ô∏è');
    }
  }

  function renderCapsuleGrid() {
    const grid = document.getElementById('capsuleGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (!capsules || capsules.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty-capsules';
      emptyDiv.style.gridColumn = '1 / -1';
      emptyDiv.innerHTML = `
        <i class="fas fa-cloud"></i>
        <p>‚òÅÔ∏è no capsules yet ‚òÅÔ∏è</p>
        <div class="sub-note">click the "NEW CAPSULE" button to seal your first memory</div>
        <div style="margin-top: 1.5rem; font-size: 0.9rem;">‚ú® every memory deserves to float ‚ú®</div>
      `;
      grid.appendChild(emptyDiv);
      return;
    }
    
    capsules.forEach(capsule => {
      const openDate = new Date(capsule.open_date);
      const now = new Date();
      const isOpen = now >= openDate;
      
      const card = document.createElement('div');
      card.className = `capsule-card ${isOpen ? 'unlocked' : 'locked'}`;
      card.setAttribute('data-id', capsule.id);
      
      if (isOpen) {
        card.onclick = () => viewCapsule(capsule.id);
      } else {
        card.onclick = () => alert('‚è≥ this capsule is still sealed. it will open on ' + openDate.toLocaleDateString());
      }
      
      card.innerHTML = `
        <div class="capsule-icon"><i class="fas ${isOpen ? 'fa-lock-open' : 'fa-lock'}"></i></div>
        <div class="capsule-title">${capsule.title}</div>
        <div class="capsule-date">opens ${openDate.toLocaleDateString()}</div>
        <span class="capsule-badge">${isOpen ? 'open now' : 'locked'}</span>
      `;
      
      grid.appendChild(card);
    });
  }

  async function viewCapsule(id) {
  try {
    const response = await fetchWithAuth('/api/capsules/' + id);
    
    if (!response.ok) {
      throw new Error('Failed to load capsule');
    }
    
    const capsule = await response.json();
    console.log('Opened capsule:', capsule);
    
    const detailView = document.getElementById('capsuleDetailView');
    const gridView = document.getElementById('capsuleGridView');
    const detailContent = document.getElementById('capsuleDetailContent');
    
    if (!detailView || !gridView || !detailContent) return;
    
    // Format the content with proper fallbacks
    const letter = capsule.letter || 'üìù no letter written';
    const secret = capsule.secret || 'ü§´ no secret shared';
    const feeling = capsule.feeling || 'üí≠ not specified';
    const rating = capsule.rating || 0;
    const song = capsule.song || 'üéµ no song added';
    
    // Create star display
    const stars = '‚≠ê'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
    
    // Format date
    const openDate = new Date(capsule.open_date);
    const formattedDate = openDate.toLocaleDateString();
    
    detailContent.innerHTML = `
      <div class="capsule-detail">
        <h2 style="font-family: 'Baloo 2'; font-size: 2rem; margin-bottom: 0.5rem;">${capsule.title}</h2>
        <p style="margin-bottom: 1.5rem;"><i class="fas fa-calendar"></i> opened on ${formattedDate}</p>
        
        ${capsule.photo_url ? `
          <div style="text-align: center; margin: 1rem 0 2rem;">
            <img src="${API_URL + capsule.photo_url}" alt="Capsule memory" style="max-width: 100%; max-height: 300px; border-radius: 20px; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
          </div>
        ` : ''}
        
        <div class="secret-content" style="margin-bottom: 1.5rem;">
          <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem;">
            <i class="fas fa-envelope" style="color: #b07a9a;"></i> letter
          </h3>
          <p style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 15px;">${letter}</p>
        </div>
        
        <div class="secret-content" style="margin-bottom: 1.5rem;">
          <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem;">
            <i class="fas fa-mask" style="color: #b07a9a;"></i> secret
          </h3>
          <p style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 15px;">${secret}</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1.5rem 0; padding: 1rem; background: rgba(255,235,245,0.3); border-radius: 20px;">
          <div style="text-align: center;">
            <i class="fas fa-heart" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
            <div>${feeling}</div>
          </div>
          <div style="text-align: center;">
            <i class="fas fa-star" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
            <div>${stars}</div>
          </div>
          <div style="text-align: center;">
            <i class="fas fa-music" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
            <div>${song}</div>
          </div>
        </div>
      </div>
    `;
    
    gridView.classList.add('hidden');
    detailView.classList.remove('hidden');
    
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

  function backToGrid() {
    const detailView = document.getElementById('capsuleDetailView');
    const gridView = document.getElementById('capsuleGridView');
    if (detailView) detailView.classList.add('hidden');
    if (gridView) gridView.classList.remove('hidden');
  }

  // ========== CREATE CAPSULE FUNCTIONS ==========
  const capsuleGridView = document.getElementById('capsuleGridView');
  const createCapsuleView = document.getElementById('createCapsuleView');
  const capsuleDetailView = document.getElementById('capsuleDetailView');

  function showCreateCapsule() {
    if (capsuleGridView) capsuleGridView.classList.add('hidden');
    if (capsuleDetailView) capsuleDetailView.classList.add('hidden');
    if (createCapsuleView) createCapsuleView.classList.remove('hidden');
    
    // Reset form
    const nameInput = document.getElementById('capsuleName');
    const dateInput = document.getElementById('capsuleOpenDate');
    const letterInput = document.getElementById('capsuleLetter');
    const secretInput = document.getElementById('capsuleSecret');
    const feelingSelect = document.getElementById('capsuleFeeling');
    const songInput = document.getElementById('capsuleSong');
    const photoInput = document.getElementById('photoUpload');
    
    if (nameInput) nameInput.value = '';
    if (dateInput) dateInput.value = '';
    if (letterInput) letterInput.value = '';
    if (secretInput) secretInput.value = '';
    if (feelingSelect) feelingSelect.value = 'happy';
    if (songInput) songInput.value = '';
    if (photoInput) photoInput.value = '';
    
    currentRating = 0;
    updateRatingStars();
  }

  // ========== WORKING RATING STARS ==========
  function setRating(rating) {
    currentRating = rating;
    updateRatingStars();
  }

  function updateRatingStars() {
    const stars = document.querySelectorAll('#ratingStars i');
    stars.forEach((star, index) => {
      if (index < currentRating) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  async function saveCapsule() {
    const title = document.getElementById('capsuleName')?.value;
    const openDate = document.getElementById('capsuleOpenDate')?.value;
    const letter = document.getElementById('capsuleLetter')?.value;
    const secret = document.getElementById('capsuleSecret')?.value;
    const feeling = document.getElementById('capsuleFeeling')?.value;
    const song = document.getElementById('capsuleSong')?.value;
    const photoFile = document.getElementById('photoUpload')?.files[0];
    
    if (!title || !openDate) {
      alert('please enter a title and open date ‚úß');
      return;
    }
    
    const formData = new FormData();
    formData.append('title', title);
    formData.append('open_date', openDate);
    formData.append('letter', letter || '');
    formData.append('secret', secret || '');
    formData.append('feeling', feeling || 'happy');
    formData.append('rating', currentRating);
    formData.append('song', song || '');
    
    if (photoFile) {
      formData.append('photo', photoFile);
    }
    
    try {
      const response = await fetch(API_URL + '/api/capsules', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to save capsule');
      }
      
      await loadCapsules();
      
      if (createCapsuleView) createCapsuleView.classList.add('hidden');
      if (capsuleGridView) capsuleGridView.classList.remove('hidden');
      
      const openDateObj = new Date(openDate);
      showNotification(
        'üì¶ Capsule Sealed', 
        `"${title}" will open on ${openDateObj.toLocaleDateString()}`,
        data.id,
        'üîí'
      );
      
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function lockCapsule() {
    saveCapsule();
  }

  // ========== CHECK FOR OPENED CAPSULES ==========
  async function checkForOpenedCapsules() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
      const response = await fetch(API_URL + '/api/capsules/check-opened', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) return;
      
      const openedCapsules = await response.json();
      
      openedCapsules.forEach(capsule => {
        showNotification(
          '‚ú® Capsule Opened!', 
          `"${capsule.title}" is ready to view - click to open`,
          capsule.id,
          'üéÅ'
        );
      });
      
      if (openedCapsules.length > 0) {
        await loadCapsules();
      }
    } catch (error) {
      console.error('Error checking opened capsules:', error);
    }
  }

  function startPeriodicChecks() {
    // Check for opened capsules immediately
    checkForOpenedCapsules();
    
    // Then check every 30 seconds
    if (notificationCheckInterval) clearInterval(notificationCheckInterval);
    notificationCheckInterval = setInterval(checkForOpenedCapsules, 30000);
  }

  // ========== AUTO LOGIN CHECK ==========
  async function checkAutoLogin() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
      const response = await fetchWithAuth('/api/auth/me');
      
      if (response.ok) {
        const data = await response.json();
        currentUser = data.user;
        authToken = token;
        
        const usernameDisplay = document.getElementById('usernameDisplay');
        if (usernameDisplay) {
          usernameDisplay.textContent = data.user.username || data.user.email.split('@')[0];
        }
        
        if (homepage) homepage.classList.add('hidden');
        if (mainApp) mainApp.classList.remove('hidden');
        
        await loadCapsules();
        startPeriodicChecks();
      } else {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      }
    } catch (error) {
      console.log('Auto login failed');
    }
  }

  // ========== INITIALIZATION ==========
  document.addEventListener('DOMContentLoaded', () => {
    checkAutoLogin();
    
    // Photo upload preview
    const photoInput = document.getElementById('photoUpload');
    if (photoInput) {
      photoInput.addEventListener('change', function(e) {
        if (e.target.files[0]) {
          alert('üì∏ photo ready for upload!');
        }
      });
    }
    
    // Initialize rating stars observer
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.target.id === 'createCapsuleView' && 
            !mutation.target.classList.contains('hidden')) {
          currentRating = 0;
          updateRatingStars();
        }
      });
    });
    
    const createView = document.getElementById('createCapsuleView');
    if (createView) {
      observer.observe(createView, { attributes: true, attributeFilter: ['class'] });
    }
  });

  // ========== CLOSE MODALS ON OUTSIDE CLICK ==========
  if (modal) {
    modal.addEventListener('click', (e) => e.target === modal && closeModal());
  }
  if (aboutModal) {
    aboutModal.addEventListener('click', (e) => e.target === aboutModal && closeAboutModal());
  }
</script>
</body>
</html>