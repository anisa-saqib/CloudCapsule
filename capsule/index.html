<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚òÅÔ∏è cloud capsule ¬∑ royal blue dreams</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Nunito:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    /* === LIGHT MODE - SOFT DREAMY PINK === */
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(145deg, #ffd9e8 0%, #ffe0f0 50%, #ffcce6 100%);
      height: 100vh;
      width: 100vw;
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === DARK MODE - ROYAL BLUE WITH GREEN HINT === */
    body.dark-mode {
      background: linear-gradient(145deg, #1E2E4F 0%, #253b5e 50%, #31487A 100%);
    }

    /* === CLOUDS BACKGROUND - NON-BLOCKING === */
    .clouds-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none !important;
      z-index: 1;
      overflow: hidden;
    }

    .cloud {
      position: absolute;
      border-radius: 1000px;
      backdrop-filter: blur(3px);
      opacity: 0.6;
      will-change: transform;
      pointer-events: none;
    }

    .cloud::before, .cloud::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
    }

    .cloud::before {
      width: 65%;
      height: 85%;
      top: -45%;
      left: 10%;
    }

    .cloud::after {
      width: 45%;
      height: 60%;
      top: -35%;
      right: 8%;
    }

    /* LIGHT MODE CLOUDS */
    body:not(.dark-mode) .cloud {
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 20px 40px rgba(255, 150, 200, 0.2);
    }

    body:not(.dark-mode) .cloud::before,
    body:not(.dark-mode) .cloud::after {
      background: rgba(255, 255, 255, 0.8);
    }

    /* DARK MODE CLOUDS */
    body.dark-mode .cloud {
      background: rgba(180, 200, 255, 0.1);
      box-shadow: 0 20px 40px rgba(0, 20, 40, 0.2);
    }

    body.dark-mode .cloud::before,
    body.dark-mode .cloud::after {
      background: rgba(180, 200, 255, 0.1);
    }

    /* CLOUD ANIMATIONS */
    @keyframes floatSlowly {
      0% { transform: translateX(-10vw) translateY(0); }
      50% { transform: translateX(40vw) translateY(-20px); }
      100% { transform: translateX(90vw) translateY(10px); }
    }

    @keyframes floatEvenSlower {
      0% { transform: translateX(-15vw) translateY(0); }
      50% { transform: translateX(50vw) translateY(15px); }
      100% { transform: translateX(110vw) translateY(-10px); }
    }

    /* 6 CLOUDS */
    .cloud1 { width: 320px; height: 115px; top: 15%; left: -5%; animation: floatSlowly 95s linear infinite; }
    .cloud2 { width: 280px; height: 100px; top: 40%; left: 20%; animation: floatEvenSlower 120s linear infinite; }
    .cloud3 { width: 360px; height: 130px; top: 70%; left: 45%; animation: floatSlowly 140s linear infinite; }
    .cloud4 { width: 240px; height: 85px; top: 25%; left: 70%; animation: floatEvenSlower 110s linear infinite; }
    .cloud5 { width: 300px; height: 110px; top: 55%; left: -10%; animation: floatSlowly 130s linear infinite; }
    .cloud6 { width: 260px; height: 95px; top: 85%; left: 30%; animation: floatEvenSlower 150s linear infinite; }

    /* === NOTIFICATION CONTAINER - CLICKABLE === */
    .notification-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .notification {
      background: rgba(255, 235, 245, 0.95);
      backdrop-filter: blur(10px);
      border: 3px solid white;
      border-radius: 30px;
      padding: 1rem 1.5rem;
      font-family: 'Baloo 2', cursive;
      color: #3a1a32;
      box-shadow: 0 5px 0 #b07a9a, 0 10px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 280px;
      max-width: 350px;
      transform: translateX(-120%);
      animation: slideIn 0.5s forwards;
      cursor: pointer;
      transition: all 0.2s ease;
      pointer-events: auto;
      position: relative;
      z-index: 10000;
    }

    .notification:hover {
      transform: scale(1.02) translateX(5px);
      box-shadow: 0 8px 0 #b07a9a, 0 15px 25px rgba(0, 0, 0, 0.15);
    }

    body.dark-mode .notification {
      background: #1E2E4F;
      color: #e8f0ff;
      border-color: #4a6080;
      box-shadow: 0 5px 0 #0f1a2a, 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .notification:hover {
      box-shadow: 0 8px 0 #0f1a2a, 0 15px 25px rgba(0, 0, 0, 0.4);
    }

    @keyframes slideIn {
      to { transform: translateX(0); }
    }

    .notification i {
      font-size: 2rem;
      color: #b07a9a;
    }

    body.dark-mode .notification i {
      color: #a0c0ff;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.2rem;
    }

    .notification-message {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* === MAIN CONTENT - CLICKABLE === */
    .homepage {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 1rem;
      pointer-events: none;
    }

    .homepage * {
      pointer-events: auto;
    }

    /* === TITLE - LIGHT MODE COLOR CHANGED === */
    .hero-title {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(3.2rem, 11vw, 6rem);
      font-weight: 800;
      color: #4a1e3a;  /* darker pink/purple for light mode */
      text-shadow: 
        5px 5px 0 #ffb0d0,
        9px 9px 0 rgba(180, 100, 140, 0.2);
      line-height: 1;
      margin-bottom: 0.3rem;
      letter-spacing: 3px;
      animation: bubble 4s ease-in-out infinite;
      transform-origin: center;
      display: block;
      white-space: normal;
      word-break: break-word;
      max-width: 90%;
    }

    body.dark-mode .hero-title {
      color: #e8f0ff;
      text-shadow: 
        4px 4px 0 #1E2E4F,
        8px 8px 0 rgba(20, 40, 60, 0.5),
        0 0 20px rgba(200, 220, 255, 0.2);
    }

    @keyframes bubble {
      0%, 100% { transform: scale(1) translateY(0); }
      50% { transform: scale(1.02) translateY(-5px); }
    }

    /* === PUNCHLINE === */
    .punchline {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(0.8rem, 2.5vw, 1.1rem);
      color: #552a45;
      text-shadow: 1px 1px 0 #ff9fc7;
      margin: 0.4rem 0 1.8rem;
      letter-spacing: 1px;
      background: rgba(255, 215, 235, 0.25);
      padding: 0.4rem 1.2rem;
      border-radius: 40px;
      backdrop-filter: blur(4px);
      border: 1.5px dashed #ffa5cc;
      display: inline-block;
    }

    body.dark-mode .punchline {
      color: #d0e0ff;
      text-shadow: 1px 1px 0 #1E2E4F;
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    /* === BUTTON CONTAINER === */
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      align-items: center;
      margin: 0.8rem 0;
      width: 100%;
      max-width: 280px;
    }

    /* GET STARTED BUTTON */
    .home-btn.get-started {
      background: rgba(255, 235, 245, 0.98);
      border: 4px solid white;
      border-radius: 60px;
      padding: 1.1rem 2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 800;
      font-size: clamp(1.2rem, 4vw, 1.6rem);
      color: #3a1a32;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 0 #b07a9a, 0 15px 30px rgba(140, 70, 100, 0.25);
      cursor: pointer;
      transition: all 0.08s linear;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: center;
      border-style: solid;
      border-color: #ffffff #d09ab8 #d09ab8 #ffffff;
    }

    .home-btn.get-started:hover {
      background: rgba(245, 225, 235, 0.98);
      border-color: #e0e0e0 #c090b0 #c090b0 #e0e0e0;
      transform: scale(1.02);
    }

    body.dark-mode .home-btn.get-started {
      background: linear-gradient(145deg, #31487A, #1E2E4F);
      color: #e8f0ff;
      border-color: #4a6080 #1a2a3a #1a2a3a #4a6080;
      box-shadow: 0 8px 0 #0f1a2a, 0 15px 30px rgba(0, 0, 0, 0.5);
    }

    /* LOGIN BUTTON */
    .home-btn.login {
      background: rgba(255, 235, 245, 0.85);
      border: 3px solid white;
      border-radius: 50px;
      padding: 0.6rem 1.4rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: clamp(0.8rem, 2.5vw, 1.1rem);
      color: #3a1a32;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 0 #b07a9a, 0 8px 15px rgba(140, 70, 100, 0.15);
      cursor: pointer;
      transition: all 0.08s linear;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      width: 70%;
      justify-content: center;
      border-style: solid;
      border-color: #ffffff #d09ab8 #d09ab8 #ffffff;
    }

    .home-btn.login:hover {
      background: rgba(245, 225, 235, 0.9);
      border-color: #e0e0e0 #c090b0 #c090b0 #e0e0e0;
      transform: scale(1.02);
    }

    body.dark-mode .home-btn.login {
      background: linear-gradient(145deg, #2a3a5a, #1E2E4F);
      color: #d0e0ff;
      border-color: #3a5070 #1a2a3a #1a2a3a #3a5070;
      box-shadow: 0 4px 0 #0f1a2a, 0 8px 15px rgba(0, 0, 0, 0.4);
    }

    /* === WELCOME MESSAGE === */
    .welcome-message {
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      color: #552a45;
      margin-top: 2.5rem;
      padding: 0.4rem 1.2rem;
      background: rgba(255, 215, 235, 0.2);
      border-radius: 40px;
      backdrop-filter: blur(4px);
      border: 1px dotted #ffa5cc;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    body.dark-mode .welcome-message {
      color: #b0c8ff;
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    /* === TOP BUTTONS - CLICKABLE === */
    .top-buttons {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
    }

    .about-btn, .dark-toggle {
      background: rgba(255, 235, 245, 0.9);
      border: 2px solid white;
      border-radius: 40px;
      padding: 0.5rem 1.2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: 0.9rem;
      color: #3a1a32;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 0 #b07a9a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.1s ease;
      pointer-events: auto;
      position: relative;
      z-index: 1001;
    }

    .about-btn:hover, .dark-toggle:hover {
      background: rgba(245, 225, 235, 0.95);
      border-color: #e0e0e0;
    }

    body.dark-mode .about-btn,
    body.dark-mode .dark-toggle {
      background: #1E2E4F;
      color: #d0e0ff;
      border-color: #4a6080;
      box-shadow: 0 4px 0 #0f1a2a;
    }

    /* === SIGN OUT BUTTON - CLICKABLE === */
    .sign-out-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #b07a9a;
      border: 3px solid white;
      border-radius: 40px;
      padding: 0.6rem 1.2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      box-shadow: 0 4px 0 #7a4a6a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
      pointer-events: auto;
      position: fixed;
      z-index: 1001;
    }

    body.dark-mode .sign-out-btn {
      background: #31487A;
      border-color: #a0c0ff;
      color: #ffffff;
      box-shadow: 0 4px 0 #1a2a3a;
    }

    .sign-out-btn:hover {
      transform: scale(1.02);
    }

    .sign-out-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #7a4a6a;
    }

    /* === MODAL OVERLAY - CLICKABLE === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
      padding: 1rem;
      pointer-events: none;
    }

    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
    }

    .modal-card {
      background: rgba(255, 245, 250, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 50px;
      border: 4px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 20px 40px rgba(140, 70, 100, 0.25), 0 8px 0 #b07a9a;
      padding: 2rem 1.8rem;
      width: 90%;
      max-width: 400px;
      position: relative;
      transform: scale(0.98);
      transition: transform 0.2s ease;
      pointer-events: auto;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-overlay.show .modal-card {
      transform: scale(1);
    }

    body.dark-mode .modal-card {
      background: #1E2E4F;
      border-color: #4a6080;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 8px 0 #0f1a2a;
    }

    .modal-card h2 {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(1.6rem, 5vw, 2rem);
      color: #3a1a32;
      margin-bottom: 1rem;
    }

    body.dark-mode .modal-card h2,
    body.dark-mode .modal-card p,
    body.dark-mode .switch-text {
      color: #d0e0ff;
    }

    .password-container {
      position: relative;
      width: 100%;
      margin: 0.6rem 0;
    }

    .password-container input {
      width: 100%;
      padding: 0.9rem 3rem 0.9rem 1.4rem !important;
      margin: 0 !important;
    }

    .peek-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #b07a9a;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .peek-icon:hover {
      color: #8a5a7a;
      transform: translateY(-50%) scale(1.1);
    }

    body.dark-mode .peek-icon {
      color: #a0c0ff;
    }

    .modal-card input {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #ffb5d0;
      border-radius: 40px;
      padding: 0.9rem 1.4rem;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      width: 100%;
      margin: 0.6rem 0;
    }

    body.dark-mode .modal-card input {
      background: #253b5e;
      border-color: #4a6080;
      color: #e8f0ff;
    }

    .modal-card input::placeholder {
      color: #b07a9a;
      opacity: 0.6;
    }

    body.dark-mode .modal-card input::placeholder {
      color: #a0c0ff;
    }

    .modal-btn {
      background: rgba(247, 200, 220, 0.98);
      border: 4px solid white;
      border-radius: 50px;
      padding: 1rem 2rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.3rem;
      color: #3a1a32;
      box-shadow: 0 6px 0 #b07a9a;
      cursor: pointer;
      width: 100%;
      margin: 1.2rem 0;
      transition: all 0.08s ease;
    }

    .modal-btn:hover {
      background: rgba(237, 190, 210, 0.98);
      border-color: #e0e0e0;
    }

    body.dark-mode .modal-btn {
      background: #31487A;
      color: #e8f0ff;
      border-color: #5a7090;
      box-shadow: 0 6px 0 #0f1a2a;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #b07a9a;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-modal:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: rotate(90deg);
    }

    body.dark-mode .close-modal {
      color: #a0c0ff;
    }

    .switch-text {
      color: #5a3a4a;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
      transition: all 0.2s ease;
    }

    .switch-text:hover {
      color: #c07aa0;
      transform: translateX(5px);
    }

    body.dark-mode .switch-text:hover {
      color: #a0c0ff;
    }

    /* === ABOUT MODAL SCROLLABLE === */
    .about-story {
      max-height: 50vh;
      overflow-y: auto;
      padding: 0.5rem 1rem 0.5rem 0;
      margin: 1rem 0;
      scrollbar-width: thin;
      scrollbar-color: #c07aa0 #ffe5f0;
      font-size: 1rem;
      line-height: 1.6;
    }

    body.dark-mode .about-story {
      scrollbar-color: #4a6080 #1E2E4F;
    }

    .about-story::-webkit-scrollbar {
      width: 6px;
    }

    .about-story::-webkit-scrollbar-track {
      background: #ffe5f0;
      border-radius: 10px;
    }

    .about-story::-webkit-scrollbar-thumb {
      background: #c07aa0;
      border-radius: 10px;
    }

    body.dark-mode .about-story::-webkit-scrollbar-track {
      background: #1E2E4F;
    }

    body.dark-mode .about-story::-webkit-scrollbar-thumb {
      background: #4a6080;
    }

    .story-chapter {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 20px;
      background: rgba(255, 215, 235, 0.2);
      transition: transform 0.2s ease;
    }

    .story-chapter:hover {
      transform: scale(1.02);
      background: rgba(255, 215, 235, 0.3);
    }

    body.dark-mode .story-chapter {
      background: rgba(49, 72, 122, 0.2);
    }

    .chapter-title {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      color: #b86a98;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    body.dark-mode .chapter-title {
      color: #a0c0ff;
    }

    .story-text {
      color: #3a1a32;
      font-size: 0.95rem;
    }

    body.dark-mode .story-text {
      color: #d0e0ff;
    }

    .fun-fact {
      background: rgba(255, 180, 210, 0.2);
      border-left: 4px solid #c07aa0;
      padding: 0.8rem;
      margin: 1rem 0;
      border-radius: 15px;
      font-style: italic;
      font-size: 0.9rem;
    }

    /* === MAIN APP DASHBOARD === */
    #mainApp {
      position: relative;
      z-index: 20;
      height: 100vh;
      width: 100vw;
      overflow-y: auto;
      padding: 5rem 1rem 2rem;
      scrollbar-width: thin;
      scrollbar-color: #c07aa0 #ffe5f0;
      pointer-events: auto;
    }

    body.dark-mode #mainApp {
      scrollbar-color: #4a6080 #1E2E4F;
    }

    .dashboard-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .glass-card {
      background: rgba(255, 245, 250, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 50px;
      border: 4px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 0 #b07a9a;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    body.dark-mode .glass-card {
      background: #1E2E4F;
      border-color: #4a6080;
      color: #e8f0ff;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 8px 0 #0f1a2a;
    }

    .welcome-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .welcome-header h1 {
      font-family: 'Baloo 2', cursive;
      font-size: clamp(1.8rem, 4vw, 2.2rem);
    }

    .create-capsule-btn {
      background: #b07a9a;
      border: 3px solid white;
      border-radius: 40px;
      padding: 0.8rem 1.5rem;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
      box-shadow: 0 5px 0 #7a4a6a;
    }

    body.dark-mode .create-capsule-btn {
      background: #31487A;
      box-shadow: 0 5px 0 #1E2E4F;
    }

    .create-capsule-btn:active {
      transform: translateY(5px);
      box-shadow: 0 2px 0 #7a4a6a;
    }

    /* === CAPSULE GRID === */
    .capsule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .capsule-card {
      background: rgba(255, 235, 245, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 1.5rem;
      border: 3px solid white;
      box-shadow: 0 8px 0 #b07a9a;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      pointer-events: auto;
    }

    body.dark-mode .capsule-card {
      background: rgba(30, 46, 79, 0.7);
      border-color: #4a6080;
      box-shadow: 0 8px 0 #0f1a2a;
    }

    /* SEALED BOX PATTERN */
    .capsule-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(45deg, 
          rgba(176, 122, 154, 0.15) 0px, 
          rgba(176, 122, 154, 0.15) 8px,
          transparent 8px, 
          transparent 16px),
        repeating-linear-gradient(-45deg, 
          rgba(176, 122, 154, 0.15) 0px, 
          rgba(176, 122, 154, 0.15) 8px,
          transparent 8px, 
          transparent 16px);
      pointer-events: none;
      z-index: 1;
    }

    body.dark-mode .capsule-card::before {
      background-image: 
        repeating-linear-gradient(45deg, 
          rgba(160, 192, 255, 0.15) 0px, 
          rgba(160, 192, 255, 0.15) 8px,
          transparent 8px, 
          transparent 16px),
        repeating-linear-gradient(-45deg, 
          rgba(160, 192, 255, 0.15) 0px, 
          rgba(160, 192, 255, 0.15) 8px,
          transparent 8px, 
          transparent 16px);
    }

    .capsule-card::after {
      content: '';
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      border: 2px dashed rgba(176, 122, 154, 0.3);
      border-radius: 20px;
      pointer-events: none;
      z-index: 1;
    }

    body.dark-mode .capsule-card::after {
      border-color: rgba(160, 192, 255, 0.3);
    }

    .capsule-card.unlocked::before,
    .capsule-card.unlocked::after {
      opacity: 0.1;
      transition: opacity 0.5s ease;
    }

    .capsule-card.locked {
      cursor: not-allowed;
      opacity: 0.9;
    }

    .capsule-card.locked:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 0 #b07a9a;
    }

    .capsule-card.unlocked:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 0 #b07a9a;
    }

    .capsule-icon {
      font-size: 2.5rem;
      color: #b07a9a;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 2;
    }

    body.dark-mode .capsule-icon {
      color: #a0c0ff;
    }

    .capsule-title {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      margin-bottom: 0.3rem;
      position: relative;
      z-index: 2;
    }

    .capsule-date {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 1rem;
      position: relative;
      z-index: 2;
    }

    .capsule-badge {
      display: inline-block;
      padding: 0.2rem 1rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: bold;
      background: #b07a9a;
      color: white;
      position: relative;
      z-index: 2;
    }

    body.dark-mode .capsule-badge {
      background: #31487A;
    }

    /* === EMPTY STATE === */
    .empty-capsules {
      text-align: center;
      padding: 4rem 2rem;
      background: rgba(255, 235, 245, 0.3);
      border-radius: 40px;
      margin: 2rem 0;
      border: 2px dashed #ffb5d0;
      grid-column: 1 / -1;
    }

    body.dark-mode .empty-capsules {
      background: rgba(30, 46, 79, 0.3);
      border-color: #4a6080;
    }

    .empty-capsules i {
      font-size: 4rem;
      color: #b07a9a;
      margin-bottom: 1rem;
      opacity: 0.7;
    }

    body.dark-mode .empty-capsules i {
      color: #a0c0ff;
    }

    .empty-capsules p {
      font-size: 1.5rem;
      font-family: 'Baloo 2', cursive;
      color: #b07a9a;
      margin-bottom: 0.5rem;
    }

    .empty-capsules .sub-note {
      font-size: 1rem;
      opacity: 0.8;
      color: #7a5a6a;
    }

    /* === CAPSULE DETAIL VIEW - WITH PHOTO GALLERY === */
    .capsule-detail {
      background: rgba(255, 235, 245, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 2rem;
      margin-top: 1rem;
    }

    body.dark-mode .capsule-detail {
      background: rgba(30, 46, 79, 0.7);
    }

    .secret-content {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    body.dark-mode .secret-content {
      background: rgba(20, 30, 50, 0.5);
    }

    .photo-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 1.5rem 0;
      justify-content: center;
    }

    .photo-gallery img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 15px;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .photo-gallery img:hover {
      transform: scale(1.05);
    }

    /* Lightbox for enlarged photos */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .lightbox.show {
      display: flex;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 20px;
      border: 4px solid white;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      color: white;
      cursor: pointer;
    }

    /* === CREATE CAPSULE FORM === */
    .capsule-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .form-section {
      background: rgba(255, 235, 245, 0.5);
      border-radius: 30px;
      padding: 1.5rem;
    }

    body.dark-mode .form-section {
      background: rgba(30, 46, 79, 0.5);
    }

    .form-section h3 {
      font-family: 'Baloo 2', cursive;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section input,
    .form-section textarea,
    .form-section select {
      width: 100%;
      padding: 0.8rem 1rem;
      margin: 0.5rem 0;
      border: 3px solid #ffb5d0;
      border-radius: 30px;
      font-family: 'Nunito', sans-serif;
      background: rgba(255, 255, 255, 0.9);
    }

    body.dark-mode .form-section input,
    body.dark-mode .form-section textarea,
    body.dark-mode .form-section select {
      background: #253b5e;
      border-color: #4a6080;
      color: #e8f0ff;
    }

    .form-section textarea {
      min-height: 100px;
      resize: vertical;
    }

    .file-upload {
      border: 3px dashed #ffb5d0;
      border-radius: 30px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    body.dark-mode .file-upload {
      border-color: #4a6080;
    }

    #photoPreview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    #photoPreview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 15px;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* === WORKING RATING STARS === */
    .rating-stars {
      display: flex;
      gap: 5px;
      margin: 0.5rem 0;
      font-size: 1.5rem;
    }

    .rating-stars i {
      color: #ffb5d0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .rating-stars i:hover,
    .rating-stars i.active {
      color: #ff9fc7;
      transform: scale(1.1);
    }

    body.dark-mode .rating-stars i {
      color: #4a6080;
    }

    body.dark-mode .rating-stars i:hover,
    body.dark-mode .rating-stars i.active {
      color: #a0c0ff;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
    }

    .save-btn, .lock-btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 40px;
      font-family: 'Baloo 2', cursive;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.08s ease;
    }

    .save-btn {
      background: #b07a9a;
      color: white;
      box-shadow: 0 6px 0 #7a4a6a;
    }

    .lock-btn {
      background: #4a6080;
      color: white;
      box-shadow: 0 6px 0 #1E2E4F;
    }

    .save-btn:active, .lock-btn:active {
      transform: translateY(6px);
      box-shadow: none;
    }

    .hidden {
      display: none !important;
    }

    .fas, .far, .fab {
      font-family: "Font Awesome 6 Free" !important;
    }

    @media (max-width: 600px) {
      .hero-title { font-size: clamp(2.8rem, 9vw, 4.5rem); }
      .punchline { font-size: 0.8rem; }
      .button-container { max-width: 240px; }
      .home-btn.login { width: 75%; }
      .top-buttons { top: 10px; left: 10px; gap: 5px; }
      .about-btn, .dark-toggle { padding: 0.4rem 1rem; font-size: 0.8rem; }
      .capsule-grid { grid-template-columns: 1fr; }
      .capsule-form { grid-template-columns: 1fr; }
      .form-actions { flex-direction: column; }
      .sign-out-btn { top: 10px; right: 10px; padding: 0.4rem 1rem; font-size: 0.8rem; }
      .modal-card { padding: 1.5rem; }
    }
  </style>
</head>
<body>

<!-- LIGHTBOX FOR ENLARGED PHOTOS -->
<div id="lightbox" class="lightbox">
  <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
  <img id="lightbox-img" src="">
</div>

<!-- NOTIFICATION CONTAINER - BOTTOM LEFT -->
<div id="notificationContainer" class="notification-container"></div>

<!-- TOP BUTTONS CONTAINER -->
<div class="top-buttons">
  <button class="about-btn" onclick="showAboutModal()">
    <i class="fas fa-cloud"></i> ABOUT
  </button>
  <button class="dark-toggle" id="darkToggleBtn" onclick="toggleDarkMode()">
    <i class="fas fa-moon"></i> <span id="darkToggleText">DARK</span>
  </button>
</div>

<!-- FLOATING CLOUDS -->
<div class="clouds-background">
  <div class="cloud cloud1"></div>
  <div class="cloud cloud2"></div>
  <div class="cloud cloud3"></div>
  <div class="cloud cloud4"></div>
  <div class="cloud cloud5"></div>
  <div class="cloud cloud6"></div>
</div>

<!-- HOMEPAGE -->
<div id="homepage" class="homepage">
  <h1 class="hero-title">CLOUD<br>CAPSULE</h1>
  <div class="punchline">‚ú¶ seal your memories in the clouds ‚ú¶</div>
  <div class="button-container">
    <button class="home-btn get-started" onclick="openModal('register')">
      <i class="fas fa-feather"></i> GET STARTED
    </button>
    <button class="home-btn login" onclick="openModal('login')">
      <i class="fas fa-key"></i> LOGIN
    </button>
  </div>
  <div class="welcome-message">
    <i class="fas fa-cloud"></i> welcome home, dreamer <i class="fas fa-cloud"></i>
  </div>
</div>

<!-- LOGIN/REGISTER/FORGOT PASSWORD MODAL -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-card">
    <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
    
    <!-- LOGIN FORM -->
    <div id="loginForm">
      <h2>‚úß welcome back ‚úß</h2>
      <input type="email" id="loginEmail" placeholder="email">
      <div class="password-container">
        <input type="password" id="loginPassword" placeholder="password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('loginPassword', this)"></i>
      </div>
      <div style="text-align: right; margin-top: -0.5rem; margin-bottom: 1rem;">
        <span class="switch-text" style="font-size: 0.8rem;" onclick="showForgotPassword()">forgot password?</span>
      </div>
      <button class="modal-btn" onclick="handleLogin()">LOG IN</button>
      <div class="switch-text" onclick="switchToRegister()">new here? get started ‚Üí</div>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" class="hidden">
      <h2>‚úß hey there! ‚úß</h2>
      <p style="font-size: 1rem; margin-bottom: 0.8rem;">ready to make some memories?</p>
      <input type="text" id="regUsername" placeholder="username">
      <input type="email" id="regEmail" placeholder="email">
      <div class="password-container">
        <input type="password" id="regPassword" placeholder="password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('regPassword', this)"></i>
      </div>
      <div class="password-container">
        <input type="password" id="regConfirm" placeholder="confirm password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('regConfirm', this)"></i>
      </div>
      <button class="modal-btn" onclick="handleRegister()">GET STARTED</button>
      <div class="switch-text" onclick="switchToLogin()">already have an account? log in ‚Üí</div>
    </div>

    <!-- FORGOT PASSWORD FORM -->
    <div id="forgotPasswordForm" class="hidden">
      <h2>‚úß reset password ‚úß</h2>
      <p style="font-size: 1rem; margin-bottom: 1rem;">enter your email to receive a reset link</p>
      <input type="email" id="resetEmail" placeholder="email">
      <button class="modal-btn" onclick="requestPasswordReset()">SEND RESET LINK</button>
      <div class="switch-text" style="margin-top: 1rem;" onclick="switchToLogin()">back to login ‚Üí</div>
    </div>

    <!-- RESET PASSWORD FORM (shown when clicking link from email) -->
    <div id="resetPasswordForm" class="hidden">
      <h2>‚úß new password ‚úß</h2>
      <p style="font-size: 1rem; margin-bottom: 1rem;">enter your new password</p>
      <div class="password-container">
        <input type="password" id="newPassword" placeholder="new password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('newPassword', this)"></i>
      </div>
      <div class="password-container">
        <input type="password" id="confirmNewPassword" placeholder="confirm password">
        <i class="fas fa-eye peek-icon" onclick="togglePasswordVisibility('confirmNewPassword', this)"></i>
      </div>
      <button class="modal-btn" onclick="resetPassword()">RESET PASSWORD</button>
      <div class="switch-text" style="margin-top: 1rem;" onclick="switchToLogin()">back to login ‚Üí</div>
    </div>
  </div>
</div>

<!-- ABOUT MODAL -->
<div id="aboutModal" class="modal-overlay">
  <div class="modal-card" style="max-width: 550px;">
    <button class="close-modal" onclick="closeAboutModal()"><i class="fas fa-times"></i></button>
    <h2 style="text-align: center;">‚úß our story ‚úß</h2>
    <div class="about-story">
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-seedling"></i> chapter 1: a tiny idea</div><div class="story-text">once upon a time, on a rainy tuesday afternoon, two friends sat in a cozy caf√©. one was writing in a journal, the other was doodling clouds. "wouldn't it be nice," said the doodler, "if we could store memories in the clouds? like, actual clouds?" and the other laughed. but the idea stuck ‚òÅÔ∏è</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-cloud-moon"></i> chapter 2: why capsules?</div><div class="story-text">we thought about time capsules ‚Äî those little boxes you bury in the backyard and forget about. but who has a backyard anymore? and who wants to dig in the mud? so we thought: what if the capsule floated? what if it lived in the clouds, safe and pretty, until you're ready to open it? ‚ú®</div><div class="fun-fact">üåà fun fact: the first prototype was called "memory marshmallow" but it sounded too edible!</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-heart"></i> chapter 3: for the dreamers</div><div class="story-text">cloud capsule is for anyone who's ever wanted to: write a letter to their future self, save a secret too precious to share, capture a feeling before it fades, or simply leave a little time capsule for someone they love. it's for the hopeless romantics, the overthinkers, the memory-hoarders, and the cloud-gazers ‚òÅÔ∏èüíï</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-clock"></i> chapter 4: how it works</div><div class="story-text">you create a capsule. you fill it with photos, letters, secrets, songs, feelings. you pick a date in the future ‚Äî maybe your birthday, maybe a random tuesday. then you lock it, and it floats away into the cloud dimension. on that special day, it floats back down, and you get to meet your past self again. ü™Ñ</div></div>
      <div class="story-chapter"><div class="chapter-title"><i class="fas fa-star"></i> chapter 5: the dream continues</div><div class="story-text">today, cloud capsule is a little corner of the internet where thousands of people store their memories. we've seen marriage proposals, graduation messages, goodbye letters to loved ones, and so many happy tears. and we're just getting started. the clouds are infinite, and so are the memories ‚ú®</div></div>
      <div style="text-align: center; margin: 2rem 0 1rem; padding: 1rem; background: rgba(199, 161, 219, 0.2); border-radius: 50px;"><p style="font-size: 1.2rem; font-family: 'Baloo 2';">thank you for being part of our story</p><p style="font-size: 0.9rem;">now go make some memories ü´ß</p></div>
    </div>
  </div>
</div>

<!-- MAIN APP - AFTER LOGIN -->
<div id="mainApp" class="hidden">
  <button class="sign-out-btn" onclick="signOut()"><i class="fas fa-sign-out-alt"></i> SIGN OUT</button>
  <div class="dashboard-container">
    <div class="glass-card">
      <div class="welcome-header">
        <div><h1>ü´ß welcome back, <span id="usernameDisplay">dreamer</span></h1><p>your memories are safe in the clouds</p></div>
        <button class="create-capsule-btn" onclick="showCreateCapsule()"><i class="fas fa-plus-circle"></i> NEW CAPSULE</button>
      </div>
    </div>

    <div id="capsuleGridView">
      <div class="glass-card">
        <h2 style="font-family: 'Baloo 2'; margin-bottom: 1.5rem;"><i class="fas fa-box-archive"></i> your capsules</h2>
        <div id="capsuleGrid" class="capsule-grid"></div>
      </div>
    </div>

    <div id="capsuleDetailView" class="hidden">
      <div class="glass-card">
        <button class="create-capsule-btn" style="margin-bottom: 1rem;" onclick="backToGrid()"><i class="fas fa-arrow-left"></i> BACK TO CAPSULES</button>
        <div id="capsuleDetailContent"></div>
      </div>
    </div>

    <div id="createCapsuleView" class="hidden">
      <div class="glass-card">
        <h2 style="font-family: 'Baloo 2'; margin-bottom: 1.5rem;"><i class="fas fa-feather"></i> create new capsule</h2>
        <div class="capsule-form">
          <div class="form-section">
            <h3><i class="fas fa-info-circle"></i> basics</h3>
            <input type="text" id="capsuleName" placeholder="capsule name">
            <input type="datetime-local" id="capsuleOpenDate">
            
            <h3 style="margin-top: 1.5rem;"><i class="fas fa-camera"></i> photos (up to 10)</h3>
            <div class="file-upload" onclick="document.getElementById('photoUpload').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
              <p>click to select multiple photos</p>
              <small style="opacity: 0.7;">you can select up to 10 images</small>
              <input type="file" id="photoUpload" style="display: none;" accept="image/*" multiple>
            </div>
            <div id="photoPreview"></div>
          </div>
          
          <div class="form-section">
            <h3><i class="fas fa-envelope"></i> letter</h3>
            <textarea id="capsuleLetter" placeholder="dear future me..."></textarea>
            <h3 style="margin-top: 1rem;"><i class="fas fa-mask"></i> secret</h3>
            <textarea id="capsuleSecret" placeholder="something only you know..."></textarea>
          </div>
          
          <div class="form-section" style="grid-column: 1 / -1;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <h3><i class="fas fa-heart"></i> feeling</h3>
                <select id="capsuleFeeling">
                  <option value="happy">happy</option>
                  <option value="nostalgic">nostalgic</option>
                  <option value="hopeful">hopeful</option>
                  <option value="thoughtful">thoughtful</option>
                  <option value="excited">excited</option>
                </select>
              </div>
              <div>
                <h3><i class="fas fa-star"></i> rating</h3>
                <div class="rating-stars" id="ratingStars">
                  <i class="fas fa-star" onclick="setRating(1)"></i>
                  <i class="fas fa-star" onclick="setRating(2)"></i>
                  <i class="fas fa-star" onclick="setRating(3)"></i>
                  <i class="fas fa-star" onclick="setRating(4)"></i>
                  <i class="fas fa-star" onclick="setRating(5)"></i>
                </div>
              </div>
              <div>
                <h3><i class="fas fa-music"></i> song</h3>
                <input type="text" id="capsuleSong" placeholder="artist - track">
              </div>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button class="save-btn" onclick="saveCapsule()"><i class="fas fa-save"></i> SAVE CAPSULE</button>
          <button class="lock-btn" onclick="lockCapsule()"><i class="fas fa-lock"></i> LOCK & SEAL</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== CONFIGURATION ==========
  const API_URL = '';
  
  // ========== STATE MANAGEMENT ==========
  let currentUser = null;
  let currentRating = 0;
  let capsules = [];
  let checkInterval = null;
  let notificationCheckInterval = null;
  let resetToken = null;

  // ========== LIGHTBOX FUNCTION ==========
  function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('show');
  }

  function closeLightbox() {
    document.getElementById('lightbox').classList.remove('show');
  }

  // ========== DARK MODE TOGGLE ==========
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const toggleBtn = document.querySelector('.dark-toggle i');
    const toggleText = document.getElementById('darkToggleText');
    
    if (document.body.classList.contains('dark-mode')) {
      toggleBtn.className = 'fas fa-sun';
      toggleText.textContent = 'LIGHT';
      localStorage.setItem('darkMode', 'true');
    } else {
      toggleBtn.className = 'fas fa-moon';
      toggleText.textContent = 'DARK';
      localStorage.setItem('darkMode', 'false');
    }
  }

  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    const toggleBtn = document.querySelector('.dark-toggle i');
    const toggleText = document.getElementById('darkToggleText');
    if (toggleBtn) toggleBtn.className = 'fas fa-sun';
    if (toggleText) toggleText.textContent = 'LIGHT';
  }

  // ========== API HELPER ==========
  async function apiRequest(endpoint, options = {}) {
    const url = API_URL + '/api/' + endpoint;
    
    options.headers = {
      ...options.headers,
      'Content-Type': 'application/json'
    };
    
    try {
      const response = await fetch(url, options);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Request failed');
      }
      
      return data;
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }

  // ========== NOTIFICATION SYSTEM ==========
  function showNotification(title, message, capsuleId, icon = 'üéÅ') {
    const container = document.getElementById('notificationContainer');
    if (!container) return;
    
    if (container.children.length > 3) {
      container.removeChild(container.firstChild);
    }
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.setAttribute('data-capsule-id', capsuleId);
    
    let iconClass = 'fa-gift';
    if (icon === 'üîí') iconClass = 'fa-lock';
    else if (icon === '‚è∞') iconClass = 'fa-clock';
    
    notification.innerHTML = `
      <i class="fas ${iconClass}"></i>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
    `;
    
    notification.addEventListener('click', function() {
      if (capsuleId) {
        viewCapsule(capsuleId);
        this.remove();
      }
    });
    
    container.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 8000);
  }

  // ========== PASSWORD PEEK TOGGLE ==========
  function togglePasswordVisibility(inputId, icon) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  // ========== MODAL CONTROL ==========
  const modal = document.getElementById('modalOverlay');
  const aboutModal = document.getElementById('aboutModal');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const forgotPasswordForm = document.getElementById('forgotPasswordForm');
  const resetPasswordForm = document.getElementById('resetPasswordForm');
  const homepage = document.getElementById('homepage');
  const mainApp = document.getElementById('mainApp');

  function openModal(type) {
    if (!modal) return;
    modal.classList.add('show');
    
    loginForm.classList.add('hidden');
    registerForm.classList.add('hidden');
    if (forgotPasswordForm) forgotPasswordForm.classList.add('hidden');
    if (resetPasswordForm) resetPasswordForm.classList.add('hidden');
    
    if (type === 'login') {
      loginForm.classList.remove('hidden');
    } else if (type === 'register') {
      registerForm.classList.remove('hidden');
    } else if (type === 'forgot') {
      forgotPasswordForm.classList.remove('hidden');
    } else if (type === 'reset') {
      resetPasswordForm.classList.remove('hidden');
    }
  }

  function closeModal() { 
    if (modal) modal.classList.remove('show'); 
  }
  
  function showAboutModal() { 
    if (aboutModal) aboutModal.classList.add('show'); 
  }
  
  function closeAboutModal() { 
    if (aboutModal) aboutModal.classList.remove('show'); 
  }
  
  function switchToRegister() { 
    openModal('register');
  }
  
  function switchToLogin() { 
    openModal('login');
  }

  function showForgotPassword() {
    openModal('forgot');
  }

  // ========== AUTH FUNCTIONS ==========
  async function handleLogin() {
    const email = document.getElementById('loginEmail')?.value;
    const password = document.getElementById('loginPassword')?.value;
    
    if (!email || !password) {
      alert('please enter email and password ‚úß');
      return;
    }
    
    try {
      const data = await apiRequest('auth/login.php', {
        method: 'POST',
        body: JSON.stringify({ email, password })
      });
      
      if (data.success) {
        currentUser = data.user;
        localStorage.setItem('user', JSON.stringify(data.user));
        
        const usernameDisplay = document.getElementById('usernameDisplay');
        if (usernameDisplay) {
          usernameDisplay.textContent = data.user.username;
        }
        
        closeModal();
        homepage.classList.add('hidden');
        mainApp.classList.remove('hidden');
        
        await loadCapsules();
        startPeriodicChecks();
      } else {
        alert('Login failed');
      }
      
    } catch (error) {
      alert('üîê ' + error.message);
    }
  }

  async function handleRegister() {
    const username = document.getElementById('regUsername')?.value;
    const email = document.getElementById('regEmail')?.value;
    const password = document.getElementById('regPassword')?.value;
    const confirm = document.getElementById('regConfirm')?.value;
    
    if (!username || !email || !password || !confirm) {
      alert('please fill all fields ‚úß');
      return;
    }
    
    if (password !== confirm) {
      alert('passwords don\'t match ‚úß');
      return;
    }
    
    try {
      const data = await apiRequest('auth/register.php', {
        method: 'POST',
        body: JSON.stringify({ username, email, password })
      });
      
      if (data.success) {
        currentUser = data.user;
        localStorage.setItem('user', JSON.stringify(data.user));
        
        const usernameDisplay = document.getElementById('usernameDisplay');
        if (usernameDisplay) {
          usernameDisplay.textContent = data.user.username;
        }
        
        closeModal();
        homepage.classList.add('hidden');
        mainApp.classList.remove('hidden');
        
        capsules = [];
        renderCapsuleGrid();
        startPeriodicChecks();
        
        alert('‚ú® welcome to cloud capsule!');
      } else {
        alert('Registration failed');
      }
      
    } catch (error) {
      alert('üìÆ ' + error.message);
    }
  }

  async function checkAuth() {
    try {
      const data = await apiRequest('auth/me.php');
      if (data.user) {
        currentUser = data.user;
        localStorage.setItem('user', JSON.stringify(data.user));
        
        const usernameDisplay = document.getElementById('usernameDisplay');
        if (usernameDisplay) {
          usernameDisplay.textContent = data.user.username;
        }
        
        homepage.classList.add('hidden');
        mainApp.classList.remove('hidden');
        
        await loadCapsules();
        startPeriodicChecks();
      }
    } catch (error) {
      console.log('Not authenticated');
    }
  }

  async function signOut() {
    try {
      await apiRequest('auth/logout.php', { method: 'POST' });
    } catch (error) {
      console.log('Logout error:', error);
    }
    
    localStorage.removeItem('user');
    currentUser = null;
    capsules = [];
    
    mainApp.classList.add('hidden');
    homepage.classList.remove('hidden');
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    if (notificationCheckInterval) {
      clearInterval(notificationCheckInterval);
      notificationCheckInterval = null;
    }
  }

  // ========== FORGOT PASSWORD FUNCTIONS ==========
  async function requestPasswordReset() {
    const email = document.getElementById('resetEmail').value;
    
    if (!email) {
      alert('please enter your email ‚úß');
      return;
    }
    
    try {
      const data = await apiRequest('auth/forgot-password.php', {
        method: 'POST',
        body: JSON.stringify({ email })
      });
      
      alert('üìß If your email exists, you will receive a reset link');
      
      setTimeout(() => {
        switchToLogin();
      }, 3000);
      
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function checkForResetToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
      apiRequest('auth/verify-reset-token.php', {
        method: 'POST',
        body: JSON.stringify({ token })
      })
      .then(data => {
        if (data.valid) {
          openModal('reset');
          resetToken = token;
        } else {
          alert('Invalid or expired reset link');
        }
      })
      .catch(err => {
        console.error('Error verifying token:', err);
      });
    }
  }

  async function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    if (!newPassword || !confirmPassword) {
      alert('please fill all fields ‚úß');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      alert('passwords don\'t match ‚úß');
      return;
    }
    
    if (newPassword.length < 6) {
      alert('password must be at least 6 characters ‚úß');
      return;
    }
    
    try {
      const data = await apiRequest('auth/reset-password.php', {
        method: 'POST',
        body: JSON.stringify({ 
          token: resetToken,
          newPassword 
        })
      });
      
      alert('‚úÖ password reset successful! you can now log in');
      
      resetToken = null;
      switchToLogin();
      
      window.history.replaceState({}, document.title, '/');
      
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // ========== CAPSULE FUNCTIONS ==========
  async function loadCapsules() {
    try {
      capsules = await apiRequest('capsules/index.php');
      renderCapsuleGrid();
    } catch (error) {
      console.error('Error loading capsules:', error);
    }
  }

  function renderCapsuleGrid() {
    const grid = document.getElementById('capsuleGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (!capsules || capsules.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty-capsules';
      emptyDiv.style.gridColumn = '1 / -1';
      emptyDiv.innerHTML = `
        <i class="fas fa-cloud"></i>
        <p>‚òÅÔ∏è no capsules yet ‚òÅÔ∏è</p>
        <div class="sub-note">click the "NEW CAPSULE" button to seal your first memory</div>
        <div style="margin-top: 1.5rem; font-size: 0.9rem;">‚ú® every memory deserves to float ‚ú®</div>
      `;
      grid.appendChild(emptyDiv);
      return;
    }
    
    capsules.forEach(capsule => {
      const openDate = new Date(capsule.open_date);
      const now = new Date();
      const isOpen = now >= openDate;
      
      const card = document.createElement('div');
      card.className = `capsule-card ${isOpen ? 'unlocked' : 'locked'}`;
      card.setAttribute('data-id', capsule.id);
      
      if (isOpen) {
        card.onclick = () => viewCapsule(capsule.id);
      } else {
        card.onclick = () => alert('‚è≥ this capsule is still sealed. it will open on ' + openDate.toLocaleDateString());
      }
      
      card.innerHTML = `
        <div class="capsule-icon"><i class="fas ${isOpen ? 'fa-lock-open' : 'fa-lock'}"></i></div>
        <div class="capsule-title">${capsule.title}</div>
        <div class="capsule-date">opens ${openDate.toLocaleDateString()}</div>
        <span class="capsule-badge">${isOpen ? 'open now' : 'locked'}</span>
      `;
      
      grid.appendChild(card);
    });
  }

  async function viewCapsule(id) {
    try {
      const capsule = await apiRequest('capsules/single.php?id=' + id);
      
      const detailView = document.getElementById('capsuleDetailView');
      const gridView = document.getElementById('capsuleGridView');
      const detailContent = document.getElementById('capsuleDetailContent');
      
      if (!detailView || !gridView || !detailContent) return;
      
      const letter = capsule.letter || 'üìù no letter written';
      const secret = capsule.secret || 'ü§´ no secret shared';
      const feeling = capsule.feeling || 'üí≠ not specified';
      const rating = capsule.rating || 0;
      const song = capsule.song || 'üéµ no song added';
      const photoUrls = capsule.photo_urls || [];
      
      const stars = '‚≠ê'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
      const openDate = new Date(capsule.open_date);
      const formattedDate = openDate.toLocaleDateString();
      
      // Create photo gallery HTML with clickable images
      let photosHTML = '';
      if (photoUrls.length > 0) {
        photosHTML = '<div class="photo-gallery">';
        photoUrls.forEach(url => {
          photosHTML += `<img src="${API_URL + url}" alt="Capsule memory" onclick="openLightbox('${API_URL + url}')">`;
        });
        photosHTML += '</div>';
      }
      
      detailContent.innerHTML = `
        <div class="capsule-detail">
          <h2 style="font-family: 'Baloo 2'; font-size: 2rem; margin-bottom: 0.5rem;">${capsule.title}</h2>
          <p style="margin-bottom: 1.5rem;"><i class="fas fa-calendar"></i> opened on ${formattedDate}</p>
          
          ${photosHTML}
          
          <div class="secret-content" style="margin-bottom: 1.5rem;">
            <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem;">
              <i class="fas fa-envelope" style="color: #b07a9a;"></i> letter
            </h3>
            <p style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 15px;">${letter}</p>
          </div>
          
          <div class="secret-content" style="margin-bottom: 1.5rem;">
            <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem;">
              <i class="fas fa-mask" style="color: #b07a9a;"></i> secret
            </h3>
            <p style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 15px;">${secret}</p>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1.5rem 0; padding: 1rem; background: rgba(255,235,245,0.3); border-radius: 20px;">
            <div style="text-align: center;">
              <i class="fas fa-heart" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
              <div>${feeling}</div>
            </div>
            <div style="text-align: center;">
              <i class="fas fa-star" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
              <div>${stars}</div>
            </div>
            <div style="text-align: center;">
              <i class="fas fa-music" style="color: #b07a9a; font-size: 1.2rem; margin-bottom: 0.3rem;"></i>
              <div>${song}</div>
            </div>
          </div>
        </div>
      `;
      
      gridView.classList.add('hidden');
      detailView.classList.remove('hidden');
      
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function backToGrid() {
    const detailView = document.getElementById('capsuleDetailView');
    const gridView = document.getElementById('capsuleGridView');
    if (detailView) detailView.classList.add('hidden');
    if (gridView) gridView.classList.remove('hidden');
  }

  // ========== CREATE CAPSULE FUNCTIONS ==========
  const capsuleGridView = document.getElementById('capsuleGridView');
  const createCapsuleView = document.getElementById('createCapsuleView');
  const capsuleDetailView = document.getElementById('capsuleDetailView');

  function showCreateCapsule() {
    if (capsuleGridView) capsuleGridView.classList.add('hidden');
    if (capsuleDetailView) capsuleDetailView.classList.add('hidden');
    if (createCapsuleView) createCapsuleView.classList.remove('hidden');
    
    document.getElementById('capsuleName').value = '';
    document.getElementById('capsuleOpenDate').value = '';
    document.getElementById('capsuleLetter').value = '';
    document.getElementById('capsuleSecret').value = '';
    document.getElementById('capsuleFeeling').value = 'happy';
    document.getElementById('capsuleSong').value = '';
    document.getElementById('photoUpload').value = '';
    document.getElementById('photoPreview').innerHTML = '';
    
    currentRating = 0;
    updateRatingStars();
  }

  function setRating(rating) {
    currentRating = rating;
    updateRatingStars();
  }

  function updateRatingStars() {
    const stars = document.querySelectorAll('#ratingStars i');
    stars.forEach((star, index) => {
      if (index < currentRating) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  // Photo preview
  document.getElementById('photoUpload')?.addEventListener('change', function(e) {
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = '';
    
    if (e.target.files.length > 10) {
      alert('‚ö†Ô∏è maximum 10 photos allowed');
      e.target.value = '';
      return;
    }
    
    for (let i = 0; i < e.target.files.length; i++) {
      const file = e.target.files[i];
      
      if (file.size > 5 * 1024 * 1024) {
        alert(`‚ö†Ô∏è ${file.name} is too large (max 5MB)`);
        continue;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(ev) {
        const img = document.createElement('img');
        img.src = ev.target.result;
        preview.appendChild(img);
      }
      
      reader.readAsDataURL(file);
    }
    
    if (e.target.files.length > 0) {
      alert(`üì∏ ${e.target.files.length} photo(s) selected`);
    }
  });

  async function saveCapsule() {
    const title = document.getElementById('capsuleName')?.value;
    const openDate = document.getElementById('capsuleOpenDate')?.value;
    const letter = document.getElementById('capsuleLetter')?.value;
    const secret = document.getElementById('capsuleSecret')?.value;
    const feeling = document.getElementById('capsuleFeeling')?.value;
    const song = document.getElementById('capsuleSong')?.value;
    const photoPreviews = document.querySelectorAll('#photoPreview img');
    
    if (!title || !openDate) {
      alert('please enter a title and open date ‚úß');
      return;
    }

    // For now, we'll send empty photo URLs
    // In a real implementation, you'd upload files first
    const photoUrls = [];

    try {
      const response = await fetch(API_URL + '/api/capsules/index.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: title,
          open_date: openDate,
          letter: letter || '',
          secret: secret || '',
          feeling: feeling || 'happy',
          rating: currentRating,
          song: song || '',
          photo_urls: photoUrls
        })
      });

      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to save capsule');
      }

      alert('‚ú® Capsule saved successfully!');
      
      // Go back to capsule grid
      document.getElementById('createCapsuleView').classList.add('hidden');
      document.getElementById('capsuleGridView').classList.remove('hidden');
      
      // Reload capsules
      await loadCapsules();
      
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function lockCapsule() {
    saveCapsule();
  }

  // ========== PERIODIC CHECKS ==========
  async function checkForOpenedCapsules() {
    try {
      const opened = await apiRequest('capsules/check-opened.php');
      opened.forEach(capsule => {
        showNotification(
          '‚ú® Capsule Opened!', 
          `"${capsule.title}" is ready to view - click to open`,
          capsule.id,
          'üéÅ'
        );
      });
      if (opened.length > 0) {
        await loadCapsules();
      }
    } catch (error) {
      console.error('Error checking opened capsules:', error);
    }
  }

  function startPeriodicChecks() {
    if (notificationCheckInterval) clearInterval(notificationCheckInterval);
    notificationCheckInterval = setInterval(checkForOpenedCapsules, 30000);
  }

  // ========== INITIALIZATION ==========
  document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    checkForResetToken();
    
    // Initialize rating stars observer
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.target.id === 'createCapsuleView' && 
            !mutation.target.classList.contains('hidden')) {
          currentRating = 0;
          updateRatingStars();
        }
      });
    });
    
    const createView = document.getElementById('createCapsuleView');
    if (createView) {
      observer.observe(createView, { attributes: true, attributeFilter: ['class'] });
    }
  });

  // ========== CLOSE MODALS ON OUTSIDE CLICK ==========
  if (modal) {
    modal.addEventListener('click', (e) => e.target === modal && closeModal());
  }
  if (aboutModal) {
    aboutModal.addEventListener('click', (e) => e.target === aboutModal && closeAboutModal());
  }
</script>
</body>
</html>